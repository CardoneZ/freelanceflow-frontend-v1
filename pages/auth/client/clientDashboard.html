<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreelanceFlow - Client Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .transition-all {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-calendar-check text-2xl"></i>
                <span class="text-xl font-bold">FreelanceFlow</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="notifications-btn" class="relative">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notification-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </button>
                <div class="relative" id="user-menu">
                    <button class="flex items-center space-x-2 focus:outline-none">
                        <img id="user-avatar" src="https://ui-avatars.com/api/?background=667eea&color=fff&name=U" class="w-8 h-8 rounded-full">
                        <span id="user-name" class="font-medium">Usuario</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Sidebar -->
            <div class="w-full md:w-64 bg-white rounded-lg shadow p-4">
                <div class="space-y-4">
                    <button id="dashboard-btn" class="w-full flex items-center space-x-3 px-4 py-3 bg-indigo-50 text-indigo-700 rounded-lg font-medium">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </button>
                    <button id="bookings-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Mis Citas</span>
                    </button>
                    <button id="messages-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
                        <i class="fas fa-envelope"></i>
                        <span>Mensajes</span>
                    </button>
                    <button id="profile-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
                        <i class="fas fa-user"></i>
                        <span>Perfil</span>
                    </button>
                    <button id="logout-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all mt-8">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesión</span>
                    </button>
                </div>
            </div>

            <!-- Main Panel -->
            <div class="flex-1">
                <!-- Welcome Banner -->
                <div class="gradient-bg text-white rounded-lg shadow-lg p-6 mb-8">
                    <h1 class="text-2xl font-bold mb-2">¡Bienvenido, <span id="welcome-name">Usuario</span>!</h1>
                    <p class="opacity-90">Encuentra profesionales para tus necesidades y agenda citas fácilmente.</p>
                </div>

                <!-- Search Section -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4">Buscar Profesionales</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">¿Qué servicio necesitas?</label>
                            <input type="text" id="service-search" placeholder="Ej. Diseño web, Consultoría" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                            <input type="text" id="location-search" placeholder="Ciudad o país" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="flex items-end">
                            <button id="search-btn" class="w-full gradient-bg text-white py-2 px-4 rounded-lg hover:opacity-90 transition-all">
                                <i class="fas fa-search mr-2"></i> Buscar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Professionals List -->
                <div id="professionals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Professionals will be loaded here dynamically -->
                    <div class="text-center py-8">
                        <i class="fas fa-search text-gray-300 text-4xl mb-2"></i>
                        <p class="text-gray-500">Busca profesionales para comenzar</p>
                    </div>
                </div>

                <!-- Booking Modal -->
                <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold" id="modal-professional-name">Agendar cita</h3>
                                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Professional Info -->
                                <div>
                                    <div class="flex items-center space-x-4 mb-4">
                                        <img id="modal-professional-avatar" src="https://via.placeholder.com/80" class="w-16 h-16 rounded-full">
                                        <div>
                                            <h4 id="modal-professional-title" class="font-semibold"></h4>
                                            <div class="flex items-center mt-1">
                                                <div class="flex text-yellow-400">
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star"></i>
                                                    <i class="fas fa-star-half-alt"></i>
                                                    <i class="far fa-star"></i>
                                                </div>
                                                <span id="modal-professional-rating" class="text-sm text-gray-600 ml-1">(4.3)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p id="modal-professional-bio" class="text-gray-600 text-sm mb-4"></p>
                                    <div class="space-y-2">
                                        <div class="flex items-center text-gray-600">
                                            <i class="fas fa-map-marker-alt mr-2 w-5"></i>
                                            <span id="modal-professional-location"></span>
                                        </div>
                                        <div class="flex items-center text-gray-600">
                                            <i class="fas fa-dollar-sign mr-2 w-5"></i>
                                            <span id="modal-professional-rate"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Booking Form -->
                                <div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Servicio</label>
                                        <select id="service-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                            <!-- Services will be loaded here -->
                                        </select>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                        <input type="text" id="date-picker" placeholder="Selecciona una fecha" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Horario Disponible</label>
                                        <select id="time-slot-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" disabled>
                                            <option value="">Selecciona una fecha primero</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Notas (Opcional)</label>
                                        <textarea id="booking-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Algo que el profesional deba saber..."></textarea>
                                    </div>
                                    
                                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-600">Subtotal:</span>
                                            <span id="booking-subtotal" class="font-medium">$0.00</span>
                                        </div>
                                        <div class="flex justify-between text-lg font-bold">
                                            <span>Total:</span>
                                            <span id="booking-total">$0.00</span>
                                        </div>
                                    </div>
                                    
                                    <button id="confirm-booking-btn" class="w-full gradient-bg text-white py-2 px-4 rounded-lg hover:opacity-90 transition-all">
                                        Confirmar Cita
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        // Aquí irá todo el JavaScript para la funcionalidad
        document.addEventListener('DOMContentLoaded', function() {
            // Configuración inicial
            const token = localStorage.getItem('freelanceFlowToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Cargar datos del usuario
            async function loadUserData() {
                try {
                    const response = await fetch('http://localhost:4000/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Error al cargar datos del usuario');
                    
                    const userData = await response.json();
                    document.getElementById('user-name').textContent = `${userData.FirstName} ${userData.LastName}`;
                    document.getElementById('welcome-name').textContent = userData.FirstName;
                    document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?background=667eea&color=fff&name=${encodeURIComponent(userData.FirstName.charAt(0)+userData.LastName.charAt(0))}`;
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            // Cargar profesionales
            async function loadProfessionals(search = '', location = '') {
                const container = document.getElementById('professionals-container');
                container.innerHTML = '<div class="col-span-3 text-center py-8"><i class="fas fa-spinner fa-spin text-indigo-500 text-4xl mb-2"></i><p class="text-gray-500">Cargando profesionales...</p></div>';
                
                try {
                    let url = 'http://localhost:4000/api/professionals';
                    if (search || location) {
                        url += `?search=${encodeURIComponent(search)}&location=${encodeURIComponent(location)}`;
                    }
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Error al cargar profesionales');
                    
                    const professionals = await response.json();
                    
                    if (professionals.length === 0) {
                        container.innerHTML = '<div class="col-span-3 text-center py-8"><i class="fas fa-search text-gray-300 text-4xl mb-2"></i><p class="text-gray-500">No se encontraron profesionales</p></div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    professionals.forEach(prof => {
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-all card-hover';
                        card.innerHTML = `
                            <div class="p-6">
                                <div class="flex items-start space-x-4">
                                    <img src="https://ui-avatars.com/api/?background=667eea&color=fff&name=${encodeURIComponent(prof.User.FirstName.charAt(0)+prof.User.LastName.charAt(0))}" class="w-16 h-16 rounded-full">
                                    <div>
                                        <h3 class="font-bold text-lg">${prof.User.FirstName} ${prof.User.LastName}</h3>
                                        <p class="text-indigo-600 font-medium">${prof.Title}</p>
                                        <div class="flex items-center mt-1">
                                            <div class="flex text-yellow-400">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star-half-alt"></i>
                                                <i class="far fa-star"></i>
                                            </div>
                                            <span class="text-sm text-gray-600 ml-1">(4.3)</span>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-gray-600 text-sm mt-3 line-clamp-2">${prof.Bio}</p>
                                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                                    <div class="flex items-center text-gray-600 text-sm">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        <span>${prof.Location}</span>
                                    </div>
                                    <div class="text-indigo-600 font-bold">
                                        $${prof.HourlyRate}/h
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-6 py-3 flex justify-end">
                                <button class="book-btn gradient-bg text-white px-4 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-all" data-professional-id="${prof.ProfessionalId}">
                                    Agendar Cita
                                </button>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                    
                    // Agregar event listeners a los botones de reserva
                    document.querySelectorAll('.book-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            openBookingModal(this.getAttribute('data-professional-id'));
                        });
                    });
                } catch (error) {
                    console.error('Error:', error);
                    container.innerHTML = '<div class="col-span-3 text-center py-8"><i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-2"></i><p class="text-gray-500">Error al cargar profesionales</p></div>';
                }
            }

            // Abrir modal de reserva
            async function openBookingModal(professionalId) {
                try {
                    // Cargar datos del profesional
                    const [profResponse, servicesResponse] = await Promise.all([
                        fetch(`http://localhost:4000/api/professionals/${professionalId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }),
                        fetch(`http://localhost:4000/api/professionals/${professionalId}/services`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        })
                    ]);
                    
                    if (!profResponse.ok || !servicesResponse.ok) throw new Error('Error al cargar datos');
                    
                    const professional = await profResponse.json();
                    const services = await servicesResponse.json();
                    
                    // Llenar información del profesional en el modal
                    document.getElementById('modal-professional-name').textContent = `Agendar con ${professional.User.FirstName} ${professional.User.LastName}`;
                    document.getElementById('modal-professional-title').textContent = professional.Title;
                    document.getElementById('modal-professional-bio').textContent = professional.Bio;
                    document.getElementById('modal-professional-location').textContent = professional.Location;
                    document.getElementById('modal-professional-rate').textContent = `$${professional.HourlyRate}/hora`;
                    document.getElementById('modal-professional-avatar').src = `https://ui-avatars.com/api/?background=667eea&color=fff&name=${encodeURIComponent(professional.User.FirstName.charAt(0)+professional.User.LastName.charAt(0))}`;
                    
                    // Llenar select de servicios
                    const serviceSelect = document.getElementById('service-select');
                    serviceSelect.innerHTML = '';
                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.ServiceId;
                        option.textContent = `${service.Name} ($${service.Price})`;
                        option.dataset.price = service.Price;
                        serviceSelect.appendChild(option);
                    });
                    
                    // Configurar datepicker
                    const datepicker = flatpickr("#date-picker", {
                        locale: "es",
                        minDate: "today",
                        disable: [
                            function(date) {
                                return (date.getDay() === 0 || date.getDay() === 6); // Deshabilitar fines de semana
                            }
                        ]
                    });
                    
                    // Event listener para cambio de fecha
                    datepicker.config.onChange.push(async function(selectedDates) {
                        const selectedDate = selectedDates[0];
                        if (!selectedDate) return;
                        
                        // Formatear fecha para la API (YYYY-MM-DD)
                        const formattedDate = selectedDate.toISOString().split('T')[0];
                        
                        // Cargar disponibilidad
                        try {
                            const response = await fetch(`http://localhost:4000/api/professionals/${professionalId}/availability?date=${formattedDate}`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (!response.ok) throw new Error('Error al cargar disponibilidad');
                            
                            const availability = await response.json();
                            const timeSlotSelect = document.getElementById('time-slot-select');
                            timeSlotSelect.innerHTML = '';
                            timeSlotSelect.disabled = false;
                            
                            if (availability.length === 0) {
                                timeSlotSelect.innerHTML = '<option value="">No hay horarios disponibles</option>';
                                timeSlotSelect.disabled = true;
                                return;
                            }
                            
                            availability.forEach(slot => {
                                const option = document.createElement('option');
                                option.value = slot.startTime;
                                option.textContent = `${new Date(slot.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${new Date(slot.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                                timeSlotSelect.appendChild(option);
                            });
                        } catch (error) {
                            console.error('Error:', error);
                            const timeSlotSelect = document.getElementById('time-slot-select');
                            timeSlotSelect.innerHTML = '<option value="">Error al cargar disponibilidad</option>';
                            timeSlotSelect.disabled = true;
                        }
                    });
                    
                    // Event listener para cambio de servicio
                    serviceSelect.addEventListener('change', function() {
                        updateBookingTotal();
                    });
                    
                    // Event listener para cambio de horario
                    document.getElementById('time-slot-select').addEventListener('change', function() {
                        updateBookingTotal();
                    });
                    
                    // Función para calcular total
                    function updateBookingTotal() {
                        const selectedService = serviceSelect.options[serviceSelect.selectedIndex];
                        if (!selectedService || !selectedService.dataset.price) return;
                        
                        const price = parseFloat(selectedService.dataset.price);
                        document.getElementById('booking-subtotal').textContent = `$${price.toFixed(2)}`;
                        document.getElementById('booking-total').textContent = `$${price.toFixed(2)}`;
                    }
                    
                    // Mostrar modal
                    document.getElementById('booking-modal').classList.remove('hidden');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al cargar datos del profesional');
                }
            }

            // Confirmar reserva
            async function confirmBooking(professionalId) {
                const serviceSelect = document.getElementById('service-select');
                const timeSlotSelect = document.getElementById('time-slot-select');
                const notes = document.getElementById('booking-notes').value;
                
                if (!serviceSelect.value || !timeSlotSelect.value) {
                    alert('Por favor selecciona un servicio y un horario');
                    return;
                }
                
                try {
                    const response = await fetch('http://localhost:4000/api/appointments', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ServiceId: serviceSelect.value,
                            ProfessionalId: professionalId,
                            StartTime: timeSlotSelect.value,
                            Notes: notes
                        })
                    });
                    
                    if (!response.ok) throw new Error('Error al crear la cita');
                    
                    const appointment = await response.json();
                    alert('Cita agendada exitosamente');
                    closeBookingModal();
                    // Aquí podrías actualizar la lista de citas del usuario si tuvieras esa sección
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al agendar la cita: ' + error.message);
                }
            }

            // Cerrar modal
            function closeBookingModal() {
                document.getElementById('booking-modal').classList.add('hidden');
                document.getElementById('service-select').innerHTML = '';
                document.getElementById('date-picker').value = '';
                document.getElementById('time-slot-select').innerHTML = '<option value="">Selecciona una fecha primero</option>';
                document.getElementById('time-slot-select').disabled = true;
                document.getElementById('booking-notes').value = '';
                document.getElementById('booking-subtotal').textContent = '$0.00';
                document.getElementById('booking-total').textContent = '$0.00';
            }

            // Event listeners
            document.getElementById('search-btn').addEventListener('click', function() {
                const search = document.getElementById('service-search').value;
                const location = document.getElementById('location-search').value;
                loadProfessionals(search, location);
            });
            
            document.getElementById('close-modal').addEventListener('click', closeBookingModal);
            
            document.getElementById('confirm-booking-btn').addEventListener('click', function() {
                const professionalId = document.querySelector('.book-btn[data-professional-id]').getAttribute('data-professional-id');
                confirmBooking(professionalId);
            });
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('freelanceFlowToken');
                window.location.href = '/login.html';
            });

            // Inicializar
            loadUserData();
            loadProfessionals();
        });
    </script>
</body>
</html>